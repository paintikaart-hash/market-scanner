<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MARKET SCANNER v9</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg0: #080a0f;
  --bg1: #0d1117;
  --bg2: #111620;
  --bg3: #161c28;
  --bg4: #1c2433;
  --border: #1e2a3a;
  --border2: #253040;
  --text: #e2e8f0;
  --muted: #4a5568;
  --muted2: #2d3748;
  --green: #00e676;
  --green-b: #00c853;
  --green-dim: rgba(0,230,118,0.12);
  --red: #ff1744;
  --red-b: #d50000;
  --red-dim: rgba(255,23,68,0.12);
  --blue: #2979ff;
  --yellow: #ffd740;
  --cyan: #00e5ff;
  --accent: #00e5ff;
  --font-mono: 'IBM Plex Mono', monospace;
  --font-sans: 'Space Grotesk', sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg0);color:var(--text);font-family:var(--font-mono);min-height:100vh;overflow-x:hidden;}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
#header{background:var(--bg1);border-bottom:1px solid var(--border);padding:0 20px;height:52px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.logo{display:flex;flex-direction:column;gap:1px;}
.logo-main{font-size:14px;font-weight:700;letter-spacing:3px;color:var(--cyan);}
.logo-sub{font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;}
.header-right{display:flex;align-items:center;gap:16px;}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.3;}}
.status-text{font-size:10px;color:var(--muted);letter-spacing:1px;}
#clock{font-size:11px;color:var(--text);letter-spacing:1px;}
#scanBtn{background:var(--cyan);color:#000;border:none;padding:8px 18px;font-family:var(--font-mono);font-size:10px;font-weight:700;letter-spacing:2px;cursor:pointer;border-radius:4px;transition:all 0.2s;}
#scanBtn:hover{background:#fff;transform:translateY(-1px);}
#scanBtn.scanning{background:var(--muted2);color:var(--muted);cursor:not-allowed;animation:scanPulse 1s infinite;}
@keyframes scanPulse{0%,100%{opacity:1;}50%{opacity:0.5;}}

/* ‚îÄ‚îÄ STATS BAR ‚îÄ‚îÄ */
#statsBar{background:var(--bg1);border-bottom:1px solid var(--border);padding:10px 20px;display:flex;gap:24px;align-items:center;}
.stat{display:flex;flex-direction:column;gap:2px;}
.stat-label{font-size:8px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;}
.stat-value{font-size:18px;font-weight:700;letter-spacing:1px;}
.stat-value.cyan{color:var(--cyan);}
.stat-value.green{color:var(--green);}
.stat-value.red{color:var(--red);}
.stat-value.yellow{color:var(--yellow);}
.stat-divider{width:1px;height:36px;background:var(--border);margin:0 4px;}

/* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
.panel{background:var(--bg1);border-bottom:1px solid var(--border);padding:10px 20px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.panel-label{font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;white-space:nowrap;}
.panel-input{background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:6px 10px;font-family:var(--font-mono);font-size:11px;border-radius:4px;outline:none;}
.panel-input:focus{border-color:var(--cyan);}
.panel-btn{background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:6px 12px;font-family:var(--font-mono);font-size:10px;letter-spacing:1px;cursor:pointer;border-radius:4px;transition:all 0.15s;white-space:nowrap;}
.panel-btn:hover{border-color:var(--cyan);color:var(--cyan);}
.panel-btn.active{background:var(--cyan);color:#000;border-color:var(--cyan);}
select.panel-input{cursor:pointer;}

/* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
#filterBar{background:var(--bg1);border-bottom:1px solid var(--border);padding:8px 20px;display:flex;gap:8px;align-items:center;}

/* ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ */
#calBar{background:var(--bg2);border-bottom:1px solid var(--border);padding:8px 20px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.cal-label{font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;}
.cal-event{font-size:10px;padding:3px 8px;border-radius:3px;letter-spacing:0.5px;}
.cal-high{background:rgba(255,23,68,0.15);border:1px solid rgba(255,23,68,0.3);color:var(--red);}
.cal-med{background:rgba(255,215,64,0.1);border:1px solid rgba(255,215,64,0.2);color:var(--yellow);}

/* ‚îÄ‚îÄ POSITIONS BAR ‚îÄ‚îÄ */
#posBar{background:var(--bg2);border-bottom:1px solid var(--border);padding:8px 20px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}

/* ‚îÄ‚îÄ MAIN GRID ‚îÄ‚îÄ */
#main{padding:20px;max-width:1600px;margin:0 auto;}
#grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;}
#noSignals{display:none;text-align:center;padding:80px 20px;color:var(--muted);}
#noSignals .ns-icon{font-size:48px;margin-bottom:16px;}
#noSignals .ns-text{font-size:12px;letter-spacing:2px;}

/* ‚îÄ‚îÄ SIGNAL CARD ‚îÄ‚îÄ */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;overflow:hidden;transition:transform 0.2s,box-shadow 0.2s;}
.card:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,0.4);}
.card.buy{border-top:2px solid var(--green);}
.card.sell{border-top:2px solid var(--red);}

.card-header{padding:14px 16px 10px;display:flex;justify-content:space-between;align-items:flex-start;}
.card-symbol{font-size:18px;font-weight:700;letter-spacing:1px;}
.card-name{font-size:10px;color:var(--muted);margin-top:2px;letter-spacing:0.5px;}
.card-badge{display:flex;flex-direction:column;align-items:flex-end;gap:4px;}
.badge-crypto{background:var(--bg4);border:1px solid var(--border2);font-size:9px;letter-spacing:1px;padding:2px 7px;border-radius:3px;color:var(--muted);}
.badge-age{font-size:9px;color:var(--muted);letter-spacing:0.5px;}

.card-price{padding:0 16px 12px;display:flex;justify-content:space-between;align-items:center;}
.price-val{font-size:22px;font-weight:600;letter-spacing:1px;}
.price-change{font-size:11px;padding:3px 8px;border-radius:3px;font-weight:600;}
.price-change.pos{background:var(--green-dim);color:var(--green);}
.price-change.neg{background:var(--red-dim);color:var(--red);}

.card-signal{padding:12px 16px;margin:0 16px;border-radius:6px;display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.card-signal.buy{background:var(--green-dim);border:1px solid rgba(0,230,118,0.2);}
.card-signal.sell{background:var(--red-dim);border:1px solid rgba(255,23,68,0.2);}
.signal-dir{font-size:20px;font-weight:700;letter-spacing:3px;display:flex;align-items:center;gap:8px;}
.signal-dir.buy{color:var(--green);}
.signal-dir.sell{color:var(--red);}
.signal-confirm{font-size:9px;letter-spacing:1px;color:var(--muted);margin-top:2px;}
.stark-badge{background:var(--bg0);border:1px solid var(--cyan);color:var(--cyan);font-size:9px;letter-spacing:2px;padding:4px 8px;border-radius:3px;}

.card-levels{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);margin:0 16px 12px;}
.level{background:var(--bg2);padding:8px 10px;}
.level-label{font-size:8px;letter-spacing:1px;color:var(--muted);text-transform:uppercase;margin-bottom:3px;}
.level-val{font-size:11px;font-weight:600;}
.level-val.entry{color:var(--text);}
.level-val.sl{color:var(--red);}
.level-val.tp1{color:#69f0ae;}
.level-val.tp2{color:var(--green);}

/* ‚îÄ‚îÄ ICHIMOKU DISPLAY ‚îÄ‚îÄ */
.card-ichimoku{padding:0 16px 10px;display:flex;gap:6px;flex-wrap:wrap;}
.ichi-tag{font-size:9px;padding:3px 7px;border-radius:3px;letter-spacing:0.5px;border:1px solid;}
.ichi-bull{background:rgba(0,230,118,0.08);border-color:rgba(0,230,118,0.25);color:var(--green);}
.ichi-bear{background:rgba(255,23,68,0.08);border-color:rgba(255,23,68,0.25);color:var(--red);}
.ichi-neut{background:var(--bg3);border-color:var(--border2);color:var(--muted);}

.card-indicators{padding:0 16px 10px;display:flex;gap:5px;flex-wrap:wrap;}
.ind-tag{font-size:9px;padding:3px 7px;border-radius:3px;background:var(--bg3);border:1px solid var(--border2);color:var(--muted);letter-spacing:0.5px;}
.ind-tag.bull{border-color:rgba(0,230,118,0.2);color:var(--green);}
.ind-tag.bear{border-color:rgba(255,23,68,0.2);color:var(--red);}

.card-tf{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);margin:0 16px 12px;border-radius:4px;overflow:hidden;}
.tf-cell{background:var(--bg2);padding:8px;text-align:center;}
.tf-label{font-size:8px;color:var(--muted);letter-spacing:1px;margin-bottom:4px;}
.tf-dot{width:8px;height:8px;border-radius:50%;margin:0 auto 3px;}
.tf-dot.buy{background:var(--green);box-shadow:0 0 6px var(--green);}
.tf-dot.sell{background:var(--red);box-shadow:0 0 6px var(--red);}
.tf-sig{font-size:9px;font-weight:600;letter-spacing:1px;}
.tf-sig.buy{color:var(--green);}
.tf-sig.sell{color:var(--red);}

.card-position{padding:8px 16px 12px;display:flex;justify-content:space-between;align-items:center;}
.pos-size{font-size:10px;color:var(--muted);}
.pos-size span{color:var(--cyan);font-weight:600;}
.pos-loss{font-size:10px;color:var(--muted);}
.pos-loss span{color:var(--red);}

.card-news{margin:0 16px 12px;background:rgba(255,215,64,0.05);border:1px solid rgba(255,215,64,0.15);border-radius:4px;padding:6px 10px;font-size:9px;color:var(--yellow);letter-spacing:0.5px;}

.card-market{padding:0 16px 12px;}
.mkt-label{font-size:8px;color:var(--muted);letter-spacing:1px;margin-bottom:4px;text-transform:uppercase;}
.mkt-bars{display:flex;gap:3px;align-items:flex-end;height:20px;}
.mkt-bar{flex:1;background:var(--bg4);border-radius:2px;transition:height 0.3s;}

/* ‚îÄ‚îÄ WATCHLIST ‚îÄ‚îÄ */
#watchlistPanel{display:none;padding:20px;max-width:1600px;margin:0 auto;}
.wl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;}
.wl-item{background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;cursor:pointer;transition:border-color 0.15s;}
.wl-item:hover{border-color:var(--border2);}
.wl-sym{font-size:12px;font-weight:600;letter-spacing:1px;}
.wl-name{font-size:9px;color:var(--muted);margin-top:1px;}
.wl-price{font-size:14px;font-weight:600;margin-top:6px;}
.wl-change{font-size:10px;margin-top:2px;font-weight:600;}
.wl-change.pos{color:var(--green);}
.wl-change.neg{color:var(--red);}

/* ‚îÄ‚îÄ LAST SCAN ‚îÄ‚îÄ */
#lastScan{text-align:center;padding:12px;font-size:9px;color:var(--muted);letter-spacing:1px;border-top:1px solid var(--border);}

/* ‚îÄ‚îÄ EXIT ALERT ‚îÄ‚îÄ */
.exit-alert{position:fixed;top:70px;right:20px;z-index:9999;background:var(--bg1);border:1px solid var(--red);border-left:4px solid var(--red);border-radius:6px;padding:14px 16px;max-width:300px;box-shadow:0 8px 32px rgba(255,23,68,0.2);}
.exit-alert-title{font-size:12px;font-weight:700;color:var(--red);letter-spacing:1px;margin-bottom:6px;}
.exit-alert-body{font-size:11px;color:var(--text);line-height:1.5;}
.exit-alert-close{font-size:9px;color:var(--muted);cursor:pointer;margin-top:8px;letter-spacing:1px;}
.exit-alert-close:hover{color:var(--text);}

/* ‚îÄ‚îÄ RISK CALC ‚îÄ‚îÄ */
.risk-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.risk-result{font-size:11px;color:var(--cyan);}

@media(max-width:600px){
  #statsBar{gap:12px;overflow-x:auto;}
  .stat-value{font-size:14px;}
  #grid{grid-template-columns:1fr;}
  .card-levels{grid-template-columns:repeat(2,1fr);}
}
</style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div class="logo">
    <div class="logo-main">MARKET SCANNER</div>
    <div class="logo-sub">45 CRYPTO ¬∑ ICHIMOKU PRO ¬∑ BINANCE LIVE ¬∑ v9</div>
  </div>
  <div class="header-right">
    <div style="display:flex;align-items:center;gap:6px;">
      <div class="live-dot"></div>
      <span class="status-text" id="statusText">LIVE</span>
    </div>
    <span id="clock"></span>
    <button id="scanBtn" onclick="runScan()">‚ü≥ SCAN STARTEN</button>
  </div>
</div>

<!-- STATS -->
<div id="statsBar">
  <div class="stat"><div class="stat-label">Gescannt</div><div class="stat-value cyan" id="statScanned">45</div></div>
  <div class="stat-divider"></div>
  <div class="stat"><div class="stat-label">Kaufsignale</div><div class="stat-value green" id="statBuy">0</div></div>
  <div class="stat-divider"></div>
  <div class="stat"><div class="stat-label">Verkaufsignale</div><div class="stat-value red" id="statSell">0</div></div>
  <div class="stat-divider"></div>
  <div class="stat"><div class="stat-label">Total</div><div class="stat-value yellow" id="statTotal">0</div></div>
  <div class="stat-divider"></div>
  <div class="stat"><div class="stat-label">Signal-Rate</div><div class="stat-value" id="statRate">0%</div></div>
</div>

<!-- RISK CALCULATOR -->
<div class="panel">
  <span class="panel-label">Risiko-Rechner:</span>
  <span class="panel-label" style="color:var(--text)">Kapital CHF</span>
  <input class="panel-input" id="capital" value="1000" style="width:90px" oninput="updateRisk()">
  <select class="panel-input" id="riskPct" onchange="updateRisk()">
    <option>1% (konservativ)</option>
    <option selected>2% (standard)</option>
    <option>3% (aggressiv)</option>
    <option>5% (sehr aggressiv)</option>
  </select>
  <span class="risk-result">‚Üí Max. Verlust pro Trade: <b id="riskResult">CHF 20</b></span>
</div>

<!-- TELEGRAM -->
<div class="panel">
  <span class="panel-label">Telegram:</span>
  <input class="panel-input" id="tgToken" type="password" placeholder="Bot Token" style="width:200px">
  <input class="panel-input" id="tgChatId" placeholder="Chat ID" style="width:130px">
  <button class="panel-btn" id="tgActivateBtn" onclick="toggleTelegram()">AKTIVIEREN</button>
  <button class="panel-btn" onclick="testTelegram()">TEST</button>
  <span id="tgStatus" style="font-size:10px;color:var(--muted);"></span>
</div>

<!-- POSITIONS -->
<div id="posBar">
  <span class="panel-label">Offene Positionen:</span>
  <div id="posList" style="display:flex;gap:6px;flex-wrap:wrap;flex:1;align-items:center;"></div>
  <button class="panel-btn" onclick="addPosition()">+ POSITION</button>
  <button class="panel-btn" onclick="clearPositions()" style="opacity:0.5;">L√ñSCHEN</button>
</div>

<!-- CALENDAR -->
<div id="calBar">
  <span class="cal-label">Wirtschaftskalender:</span>
  <span id="calEvents"></span>
</div>

<!-- FILTER -->
<div id="filterBar">
  <span class="panel-label" style="margin-right:4px;">Filter:</span>
  <button class="panel-btn active" id="fAll" onclick="setFilter('all')">ALLE</button>
  <button class="panel-btn" id="fBuy" onclick="setFilter('buy')">‚ñ≤ KAUFEN</button>
  <button class="panel-btn" id="fSell" onclick="setFilter('sell')">‚ñº VERKAUFEN</button>
  <div style="flex:1"></div>
  <button class="panel-btn" id="fWl" onclick="setFilter('watchlist')">‚â° WATCHLIST</button>
</div>

<!-- MAIN -->
<div id="main">
  <div id="grid"></div>
  <div id="watchlistPanel"></div>
  <div id="noSignals">
    <div class="ns-icon">‚óá</div>
    <div class="ns-text">KEINE SIGNALE ‚Äì SCAN STARTEN</div>
  </div>
</div>
<div id="lastScan">‚Äì</div>

<script>
// ‚îÄ‚îÄ 45 COINS ‚îÄ‚îÄ
const UNIVERSE = [
  {symbol:'BTCUSDT',label:'BTC/USD',name:'Bitcoin'},
  {symbol:'ETHUSDT',label:'ETH/USD',name:'Ethereum'},
  {symbol:'BNBUSDT',label:'BNB/USD',name:'Binance Coin'},
  {symbol:'SOLUSDT',label:'SOL/USD',name:'Solana'},
  {symbol:'XRPUSDT',label:'XRP/USD',name:'XRP'},
  {symbol:'ADAUSDT',label:'ADA/USD',name:'Cardano'},
  {symbol:'AVAXUSDT',label:'AVAX/USD',name:'Avalanche'},
  {symbol:'DOTUSDT',label:'DOT/USD',name:'Polkadot'},
  {symbol:'LINKUSDT',label:'LINK/USD',name:'Chainlink'},
  {symbol:'POLUSDT',label:'POL/USD',name:'Polygon'},
  {symbol:'DOGEUSDT',label:'DOGE/USD',name:'Dogecoin'},
  {symbol:'LTCUSDT',label:'LTC/USD',name:'Litecoin'},
  {symbol:'ATOMUSDT',label:'ATOM/USD',name:'Cosmos'},
  {symbol:'NEARUSDT',label:'NEAR/USD',name:'NEAR Protocol'},
  {symbol:'UNIUSDT',label:'UNI/USD',name:'Uniswap'},
  {symbol:'SUIUSDT',label:'SUI/USD',name:'Sui'},
  {symbol:'INJUSDT',label:'INJ/USD',name:'Injective'},
  {symbol:'ARBUSDT',label:'ARB/USD',name:'Arbitrum'},
  {symbol:'OPUSDT',label:'OP/USD',name:'Optimism'},
  {symbol:'RENDERUSDT',label:'RNDR/USD',name:'Render'},
  {symbol:'TONUSDT',label:'TON/USD',name:'Toncoin'},
  {symbol:'PEPEUSDT',label:'PEPE/USD',name:'Pepe'},
  {symbol:'WIFUSDT',label:'WIF/USD',name:'dogwifhat'},
  {symbol:'BONKUSDT',label:'BONK/USD',name:'Bonk'},
  {symbol:'JUPUSDT',label:'JUP/USD',name:'Jupiter'},
  {symbol:'SEIUSDT',label:'SEI/USD',name:'Sei'},
  {symbol:'TIAUSDT',label:'TIA/USD',name:'Celestia'},
  {symbol:'PYTHUSDT',label:'PYTH/USD',name:'Pyth Network'},
  {symbol:'STRKUSDT',label:'STRK/USD',name:'Starknet'},
  {symbol:'MANTAUSDT',label:'MANTA/USD',name:'Manta Network'},
  {symbol:'AAVEUSDT',label:'AAVE/USD',name:'Aave'},
  {symbol:'MKRUSDT',label:'MKR/USD',name:'Maker'},
  {symbol:'CRVUSDT',label:'CRV/USD',name:'Curve'},
  {symbol:'LDOUSDT',label:'LDO/USD',name:'Lido DAO'},
  {symbol:'EIGENUSDT',label:'EIGEN/USD',name:'Eigenlayer'},
  {symbol:'PENDLEUSDT',label:'PENDLE/USD',name:'Pendle'},
  {symbol:'BLURUSDT',label:'BLUR/USD',name:'Blur'},
  {symbol:'GMXUSDT',label:'GMX/USD',name:'GMX'},
  {symbol:'DYDXUSDT',label:'DYDX/USD',name:'dYdX'},
  {symbol:'ETHFIUSDT',label:'ETHFI/USD',name:'Ether.fi'},
  {symbol:'FETUSDT',label:'FET/USD',name:'Fetch.ai'},
  {symbol:'AGIXUSDT',label:'AGIX/USD',name:'SingularityNET'},
  {symbol:'OCEANUSDT',label:'OCEAN/USD',name:'Ocean Protocol'},
  {symbol:'TAOUSDT',label:'TAO/USD',name:'Bittensor'},
  {symbol:'WLDUSDT',label:'WLD/USD',name:'Worldcoin'},
];

// ‚îÄ‚îÄ INDIKATOREN ‚îÄ‚îÄ
function ema(d,p){
  if(!d||d.length<2)return d?.[d.length-1]||0;
  const k=2/(p+1);const s=Math.min(p,d.length);
  let v=d.slice(0,s).reduce((a,b)=>a+b,0)/s;
  for(let i=s;i<d.length;i++)v=d[i]*k+v*(1-k);
  return v;
}

function rsi(c,p=14){
  if(c.length<p+1)return 50;
  let g=0,l=0;const s=c.length-p;
  for(let i=s;i<c.length;i++){const d=c[i]-c[i-1];if(d>0)g+=d;else l-=d;}
  const ag=g/p,al=l/p;
  if(al===0)return 100;return 100-100/(1+ag/al);
}

function atrFn(c,p=14){
  if(c.length<p+1)return c[c.length-1]*0.01;
  const trs=[];
  for(let i=1;i<c.length;i++)trs.push(Math.abs(c[i]-c[i-1]));
  return trs.slice(-p).reduce((a,b)=>a+b,0)/p;
}

// OBV
function obv(closes,volumes){
  if(!volumes||volumes.length<2)return{trend:'neutral'};
  let o=0;
  const obvArr=[];
  for(let i=1;i<Math.min(closes.length,volumes.length);i++){
    if(closes[i]>closes[i-1])o+=volumes[i];
    else if(closes[i]<closes[i-1])o-=volumes[i];
    obvArr.push(o);
  }
  if(obvArr.length<10)return{trend:'neutral'};
  const recent=obvArr.slice(-5).reduce((a,b)=>a+b,0)/5;
  const older=obvArr.slice(-15,-5).reduce((a,b)=>a+b,0)/10;
  if(recent>older*1.02)return{trend:'bull',val:o};
  if(recent<older*0.98)return{trend:'bear',val:o};
  return{trend:'neutral',val:o};
}

// ICHIMOKU CLOUD
function ichimoku(closes){
  const n=closes.length;
  if(n<52)return null;

  const tenkanP=9,kijunP=26,senkouBP=52;

  function midpoint(arr,from,len){
    const sl=arr.slice(from,from+len);
    return(Math.max(...sl)+Math.min(...sl))/2;
  }

  const last=n-1;
  const tenkan=midpoint(closes,last-tenkanP+1,tenkanP);
  const kijun=midpoint(closes,last-kijunP+1,kijunP);
  const senkouA=(tenkan+kijun)/2;
  const senkouB=midpoint(closes,last-senkouBP+1,senkouBP);

  // Chikou: current close vs close 26 periods ago
  const chikou=closes[last];
  const chikouRef=closes[last-kijunP]||closes[0];

  const price=closes[last];
  const cloudTop=Math.max(senkouA,senkouB);
  const cloudBottom=Math.min(senkouA,senkouB);

  const aboveCloud=price>cloudTop;
  const belowCloud=price<cloudBottom;
  const inCloud=!aboveCloud&&!belowCloud;

  const tkBull=tenkan>kijun;
  const tkBear=tenkan<kijun;
  const chikouBull=chikou>chikouRef;
  const chikouBear=chikou<chikouRef;
  const cloudBull=senkouA>senkouB;
  const cloudBear=senkouA<senkouB;

  // Strong signal: all components aligned
  let score=0;
  if(aboveCloud)score+=2; else if(belowCloud)score-=2;
  if(tkBull)score++; else if(tkBear)score--;
  if(chikouBull)score++; else if(chikouBear)score--;
  if(cloudBull)score+=0.5; else if(cloudBear)score-=0.5;

  return{
    score,
    signal:score>=2?'buy':score<=-2?'sell':'neutral',
    aboveCloud,belowCloud,inCloud,
    tkBull,tkBear,chikouBull,chikouBear,
    cloudBull,cloudBear,
    tenkan,kijun,senkouA,senkouB,
    cloudTop,cloudBottom,price
  };
}

// MARKET STRUCTURE
function marketStructure(closes){
  if(closes.length<20)return{trend:'neutral'};
  const recent=closes.slice(-20);
  let hh=0,hl=0,lh=0,ll=0;
  for(let i=2;i<recent.length;i++){
    const prev=recent[i-2],curr=recent[i];
    if(curr>prev)hh++; else lh++;
    if(curr>recent[i-1])hl++; else ll++;
  }
  if(hh>lh&&hl>ll)return{trend:'bull'};
  if(lh>hh&&ll>hl)return{trend:'bear'};
  return{trend:'neutral'};
}

// MAIN ANALYZE
function analyze(closes,volumes){
  if(!closes||closes.length<52)return null;

  const ichi=ichimoku(closes);
  if(!ichi)return null;

  const r=rsi(closes);
  const obvResult=obv(closes,volumes||[]);
  const ms=marketStructure(closes);

  let score=0;

  // Ichimoku (most important ‚Äì weight 3)
  score+=ichi.score;

  // RSI filter ‚Äì don't buy overbought, don't sell oversold
  if(r<35)score+=1;
  else if(r>65)score-=1;
  // Hard filter: RSI>75 suppresses buy, RSI<25 suppresses sell
  if(r>75&&score>0)score=Math.min(score,1);
  if(r<25&&score<0)score=Math.max(score,-1);

  // OBV confirmation
  if(obvResult.trend==='bull')score+=0.5;
  else if(obvResult.trend==='bear')score-=0.5;

  // Market structure
  if(ms.trend==='bull')score+=0.5;
  else if(ms.trend==='bear')score-=0.5;

  return{
    signal:score>=2?'buy':score<=-2?'sell':'neutral',
    score,
    rsi:r,
    ichi,
    obv:obvResult,
    ms
  };
}

// ‚îÄ‚îÄ BINANCE FETCH ‚îÄ‚îÄ
async function fetchBinance(symbol,interval,limit=150){
  try{
    const url=`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
    const res=await fetch(url);
    if(!res.ok)return null;
    const data=await res.json();
    if(!Array.isArray(data)||data.length<5)return null;
    const closes=data.map(k=>parseFloat(k[4])).filter(v=>!isNaN(v)&&v>0);
    const volumes=data.map(k=>parseFloat(k[5])).filter(v=>!isNaN(v)&&v>=0);
    return{closes,volumes};
  }catch(e){return null;}
}

async function fetchPrice(symbol){
  try{
    const url=`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`;
    const res=await fetch(url);
    if(!res.ok)return null;
    const d=await res.json();
    return{price:parseFloat(d.lastPrice),change:parseFloat(d.priceChangePercent)};
  }catch(e){return null;}
}

// ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ
function fmtPrice(p){
  if(p>1000)return p.toLocaleString('de-CH',{maximumFractionDigits:0});
  if(p>1)return p.toFixed(2);
  if(p>0.01)return p.toFixed(4);
  return p.toFixed(7);
}

// ‚îÄ‚îÄ RISK ‚îÄ‚îÄ
let riskAmount=20;
function updateRisk(){
  const cap=parseFloat(document.getElementById('capital').value)||1000;
  const pct=parseFloat(document.getElementById('riskPct').value)||2;
  riskAmount=cap*(pct/100);
  document.getElementById('riskResult').textContent=`CHF ${riskAmount.toFixed(0)}`;
}

// ‚îÄ‚îÄ TELEGRAM ‚îÄ‚îÄ
let tgActive=false;
function loadTgSettings(){
  const t=localStorage.getItem('tgToken'),c=localStorage.getItem('tgChatId');
  if(t)document.getElementById('tgToken').value=t;
  if(c)document.getElementById('tgChatId').value=c;
  if(t&&c){tgActive=true;document.getElementById('tgActivateBtn').classList.add('active');document.getElementById('tgStatus').textContent='‚óè AKTIV';}
}
function toggleTelegram(){
  const t=document.getElementById('tgToken').value.trim();
  const c=document.getElementById('tgChatId').value.trim();
  if(!t||!c){alert('Token und Chat-ID eingeben!');return;}
  tgActive=!tgActive;
  if(tgActive){localStorage.setItem('tgToken',t);localStorage.setItem('tgChatId',c);document.getElementById('tgActivateBtn').classList.add('active');document.getElementById('tgStatus').textContent='‚óè AKTIV';}
  else{document.getElementById('tgActivateBtn').classList.remove('active');document.getElementById('tgStatus').textContent='';}
}
async function sendTelegram(msg){
  if(!tgActive)return;
  const t=document.getElementById('tgToken').value.trim();
  const c=document.getElementById('tgChatId').value.trim();
  try{await fetch(`https://api.telegram.org/bot${t}/sendMessage`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:c,text:msg,parse_mode:'HTML'})});}
  catch(e){}
}
async function testTelegram(){
  const t=document.getElementById('tgToken').value.trim();
  const c=document.getElementById('tgChatId').value.trim();
  if(!t||!c){alert('Token und Chat-ID eingeben!');return;}
  try{
    const res=await fetch(`https://api.telegram.org/bot${t}/sendMessage`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:c,text:'‚úÖ Market Scanner v9 ‚Äì Telegram verbunden!',parse_mode:'HTML'})});
    const d=await res.json();
    alert(d.ok?'‚úÖ Telegram funktioniert!':'‚ùå Fehler: '+d.description);
  }catch(e){alert('‚ùå Fehler: '+e.message);}
}

// ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ
const EVENTS=[
  {name:'FOMC',date:'2026-03-19',impact:'high'},
  {name:'CPI USA',date:'2026-03-12',impact:'high'},
  {name:'NFP USA',date:'2026-03-06',impact:'high'},
  {name:'EZB Zinsentscheid',date:'2026-04-16',impact:'high'},
];
function renderCalendar(){
  const now=new Date();
  const span=document.getElementById('calEvents');
  const upcoming=EVENTS.filter(e=>{
    const d=new Date(e.date);
    const diff=(d-now)/(1000*60*60*24);
    return diff>=-1&&diff<=7;
  });
  if(!upcoming.length){span.innerHTML='<span style="font-size:10px;color:var(--muted)">Keine Events diese Woche</span>';return;}
  span.innerHTML=upcoming.map(e=>{
    const d=new Date(e.date);
    const diff=Math.round((d-now)/(1000*60*60*24));
    const label=diff===0?'HEUTE':diff===1?'MORGEN':`in ${diff}T`;
    return`<span class="cal-event ${e.impact==='high'?'cal-high':'cal-med'}">‚ö† ${e.name} ${label}</span>`;
  }).join('');
}

// ‚îÄ‚îÄ OPEN POSITIONS ‚îÄ‚îÄ
let openPositions=JSON.parse(localStorage.getItem('openPositions')||'[]');
function savePositions(){localStorage.setItem('openPositions',JSON.stringify(openPositions));}
function renderPositions(){
  const list=document.getElementById('posList');
  if(!list)return;
  if(!openPositions.length){list.innerHTML='<span style="font-size:10px;color:var(--muted)">Keine Positionen</span>';return;}
  list.innerHTML=openPositions.map((p,i)=>`
    <div style="background:var(--bg3);border:1px solid ${p.dir==='long'?'var(--green-b)':'var(--red-b)'};border-radius:4px;padding:3px 10px;font-size:10px;display:flex;gap:8px;align-items:center;">
      <span style="color:${p.dir==='long'?'var(--green)':'var(--red)'};font-weight:700;">${p.dir==='long'?'‚ñ≤':'‚ñº'} ${p.label}</span>
      <span style="color:var(--muted)">@ ${p.entry}</span>
      <span onclick="removePosition(${i})" style="color:var(--muted);cursor:pointer;">‚úï</span>
    </div>`).join('');
}
function addPosition(){
  const label=prompt('Symbol (z.B. XRP/USD):');if(!label)return;
  const dir=prompt('Richtung: long oder short:')?.toLowerCase();
  if(dir!=='long'&&dir!=='short'){alert('Nur long oder short');return;}
  const entry=parseFloat(prompt('Entry Preis:'));if(isNaN(entry))return;
  const coin=UNIVERSE.find(c=>c.label.toLowerCase()===label.toLowerCase());
  openPositions.push({label:label.toUpperCase(),dir,entry,symbol:coin?.symbol||null});
  savePositions();renderPositions();
}
function removePosition(i){openPositions.splice(i,1);savePositions();renderPositions();}
function clearPositions(){if(!confirm('Alle l√∂schen?'))return;openPositions=[];savePositions();renderPositions();}
function checkExitSignals(signals){
  if(!openPositions.length)return;
  for(const pos of openPositions){
    const sig=signals.find(s=>s.label===pos.label||s.symbol===pos.symbol);
    if(!sig)continue;
    const shouldExit=(pos.dir==='long'&&sig.signal==='sell')||(pos.dir==='short'&&sig.signal==='buy');
    if(!shouldExit)continue;
    const exitDir=pos.dir==='long'?'VERKAUFEN':'KAUFEN';
    const div=document.createElement('div');
    div.className='exit-alert';
    div.innerHTML=`<div class="exit-alert-title">‚ö† EXIT SIGNAL</div>
      <div class="exit-alert-body">${pos.label} ‚Äì Trend dreht auf <b>${exitDir}</b><br>Offene ${pos.dir.toUpperCase()} Position (Entry: ${pos.entry}) pr√ºfen!<br>Aktuell: ${fmtPrice(sig.price)}</div>
      <div class="exit-alert-close" onclick="this.parentElement.remove()">‚úï SCHLIESSEN</div>`;
    document.body.appendChild(div);
    setTimeout(()=>div?.remove(),60000);
    sendTelegram(`‚ö†Ô∏è EXIT SIGNAL: ${pos.label}\nTrend dreht auf ${exitDir}!\nOffene ${pos.dir.toUpperCase()} Position (Entry: ${pos.entry}) pr√ºfen!\nAktuell: ${fmtPrice(sig.price)}`);
  }
}

// ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ
let currentFilter='all';
function setFilter(f){
  currentFilter=f;
  ['All','Buy','Sell','Wl'].forEach(x=>{document.getElementById('f'+x)?.classList.remove('active');});
  document.getElementById('f'+f.charAt(0).toUpperCase()+f.slice(1))?.classList.add('active');
  const main=document.getElementById('main');
  const wl=document.getElementById('watchlistPanel');
  if(f==='watchlist'){main.style.display='none';wl.style.display='block';renderWatchlist();}
  else{main.style.display='block';wl.style.display='none';renderSignals();}
}

// ‚îÄ‚îÄ RENDER CARD ‚îÄ‚îÄ
function ichiTags(ichi){
  const tags=[];
  if(ichi.aboveCloud)tags.push({c:'bull',t:'√úBER CLOUD'});
  else if(ichi.belowCloud)tags.push({c:'bear',t:'UNTER CLOUD'});
  else tags.push({c:'neut',t:'IN CLOUD'});
  if(ichi.tkBull)tags.push({c:'bull',t:'TK BULL'});
  else if(ichi.tkBear)tags.push({c:'bear',t:'TK BEAR'});
  if(ichi.chikouBull)tags.push({c:'bull',t:'CHIKOU BULL'});
  else if(ichi.chikouBear)tags.push({c:'bear',t:'CHIKOU BEAR'});
  if(ichi.cloudBull)tags.push({c:'bull',t:'CLOUD GR√úN'});
  else if(ichi.cloudBear)tags.push({c:'bear',t:'CLOUD ROT'});
  return tags.map(t=>`<span class="ichi-tag ichi-${t.c}">${t.t}</span>`).join('');
}

function renderCard(sig){
  const isBuy=sig.signal==='buy';
  const slPct=Math.abs((sig.sl-sig.price)/sig.price*100).toFixed(1);
  const tp1Pct=Math.abs((sig.tp1-sig.price)/sig.price*100).toFixed(1);
  const rr=(tp1Pct/slPct).toFixed(1);
  const r=sig.analysis1h?.rsi||sig.analysis4h?.rsi||50;
  const msText=sig.analysis1h?.ms?.trend||'neutral';
  const obvText=sig.analysis4h?.obv?.trend||'neutral';
  const newsWarning=getNewsWarning(sig.label);

  // Indicator tags
  const indTags=[];
  indTags.push(`<span class="ind-tag ${r<35?'bull':r>65?'bear':''}"">RSI ${r.toFixed(0)}</span>`);
  indTags.push(`<span class="ind-tag ${obvText==='bull'?'bull':obvText==='bear'?'bear':''}"">OBV ${obvText.toUpperCase()}</span>`);
  indTags.push(`<span class="ind-tag ${msText==='bull'?'bull':msText==='bear'?'bear':''}"">STRUKTUR ${msText.toUpperCase()}</span>`);

  return`<div class="card ${sig.signal}">
    <div class="card-header">
      <div><div class="card-symbol">${sig.label}</div><div class="card-name">${sig.name}</div></div>
      <div class="card-badge"><span class="badge-crypto">CRYPTO</span><span class="badge-age" id="age_${sig.symbol}">${timeSince(sig.ts)}</span></div>
    </div>
    <div class="card-price">
      <div class="price-val">${fmtPrice(sig.price)}</div>
      <div class="price-change ${sig.change>=0?'pos':'neg'}">${sig.change>=0?'+':''}${sig.change?.toFixed(2)||'0.00'}%</div>
    </div>
    <div class="card-signal ${sig.signal}">
      <div>
        <div class="signal-dir ${sig.signal}">${isBuy?'‚ñ≤ KAUFEN':'‚ñº VERKAUFEN'}</div>
        <div class="signal-confirm">ALLE 3 TIMEFRAMES BEST√ÑTIGT</div>
      </div>
      <div class="stark-badge">‚òÖ STARK</div>
    </div>
    <div class="card-levels">
      <div class="level"><div class="level-label">Entry</div><div class="level-val entry">${fmtPrice(sig.price)}</div></div>
      <div class="level"><div class="level-label">Stop-Loss</div><div class="level-val sl">${fmtPrice(sig.sl)}</div></div>
      <div class="level"><div class="level-label">TP 1</div><div class="level-val tp1">${fmtPrice(sig.tp1)}</div></div>
      <div class="level"><div class="level-label">TP 2</div><div class="level-val tp2">${fmtPrice(sig.tp2)}</div></div>
    </div>
    <div class="card-ichimoku">${ichiTags(sig.ichi)}</div>
    <div class="card-indicators">${indTags.join('')}</div>
    ${newsWarning?`<div class="card-news">‚ö† NEWS-RISIKO: ${newsWarning}</div>`:''}
    <div class="card-tf">
      <div class="tf-cell"><div class="tf-label">1H</div><div class="tf-dot ${sig.tf1h}"></div><div class="tf-sig ${sig.tf1h}">${sig.tf1h.toUpperCase()}</div></div>
      <div class="tf-cell"><div class="tf-label">4H</div><div class="tf-dot ${sig.tf4h}"></div><div class="tf-sig ${sig.tf4h}">${sig.tf4h.toUpperCase()}</div></div>
      <div class="tf-cell"><div class="tf-label">1D</div><div class="tf-dot ${sig.tf1d}"></div><div class="tf-sig ${sig.tf1d}">${sig.tf1d.toUpperCase()}</div></div>
    </div>
    <div class="card-position">
      <div class="pos-size">POSITIONSGR√ñSSE: <span>${(riskAmount/((sig.sl-sig.price<0?sig.price-sig.sl:sig.sl-sig.price))).toFixed(3)} Coins</span></div>
      <div class="pos-loss">MAX. VERLUST: <span>CHF ${riskAmount.toFixed(0)}</span></div>
    </div>
  </div>`;
}

function timeSince(ts){
  if(!ts)return'';
  const s=Math.floor((Date.now()-ts)/1000);
  if(s<60)return`${s}s`;if(s<3600)return`${Math.floor(s/60)}min`;return`${Math.floor(s/3600)}h`;
}

function getNewsWarning(label){
  const calEl=document.getElementById('calEvents');
  if(!calEl||!calEl.textContent.includes('HEUTE')&&!calEl.textContent.includes('MORGEN'))return null;
  const text=calEl.textContent;
  if(text.includes('HEUTE'))return text.split('HEUTE')[0].split('‚ö† ').pop()+' HEUTE ‚Äì Vorsicht beim Einstieg!';
  return null;
}

// ‚îÄ‚îÄ RENDER SIGNALS ‚îÄ‚îÄ
let allSignals=[];
function renderSignals(){
  const grid=document.getElementById('grid');
  const noSig=document.getElementById('noSignals');
  let filtered=allSignals;
  if(currentFilter==='buy')filtered=allSignals.filter(s=>s.signal==='buy');
  else if(currentFilter==='sell')filtered=allSignals.filter(s=>s.signal==='sell');
  if(!filtered.length){grid.innerHTML='';noSig.style.display='block';return;}
  noSig.style.display='none';
  grid.innerHTML=filtered.map(renderCard).join('');
}

function updateSummary(){
  const buys=allSignals.filter(s=>s.signal==='buy').length;
  const sells=allSignals.filter(s=>s.signal==='sell').length;
  const total=buys+sells;
  document.getElementById('statScanned').textContent=UNIVERSE.length;
  document.getElementById('statBuy').textContent=buys;
  document.getElementById('statSell').textContent=sells;
  document.getElementById('statTotal').textContent=total;
  document.getElementById('statRate').textContent=Math.round(total/UNIVERSE.length*100)+'%';
}

// ‚îÄ‚îÄ WATCHLIST ‚îÄ‚îÄ
let watchPrices={};
async function renderWatchlist(){
  const panel=document.getElementById('watchlistPanel');
  if(!Object.keys(watchPrices).length){
    panel.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted);font-size:11px;letter-spacing:2px;">PREISE LADEN...</div>';
    await loadWatchlistPrices();
  }
  panel.innerHTML=`<div class="wl-grid">${UNIVERSE.map(c=>{
    const p=watchPrices[c.symbol];
    return`<div class="wl-item">
      <div class="wl-sym">${c.label}</div>
      <div class="wl-name">${c.name}</div>
      <div class="wl-price">${p?fmtPrice(p.price):'‚Äì'}</div>
      <div class="wl-change ${p&&p.change>=0?'pos':'neg'}">${p?(p.change>=0?'+':'')+p.change.toFixed(2)+'%':'‚Äì'}</div>
    </div>`;}).join('')}</div>`;
}
async function loadWatchlistPrices(){
  const batch=UNIVERSE.map(c=>fetchPrice(c.symbol));
  const results=await Promise.all(batch);
  results.forEach((r,i)=>{if(r)watchPrices[UNIVERSE[i].symbol]=r;});
}

// ‚îÄ‚îÄ MAIN SCAN ‚îÄ‚îÄ
async function runScan(){
  const btn=document.getElementById('scanBtn');
  btn.classList.add('scanning');btn.textContent='‚ü≥ SCANNE...';
  document.getElementById('statusText').textContent='SCANNING';
  allSignals=[];
  const newSignals=[];

  for(const coin of UNIVERSE){
    try{
      const [d1h,d4h,d1d]=await Promise.all([
        fetchBinance(coin.symbol,'1h',150),
        fetchBinance(coin.symbol,'4h',150),
        fetchBinance(coin.symbol,'1d',400),
      ]);
      if(!d1h||!d4h||!d1d||d1h.closes.length<52)continue;

      const a1h=analyze(d1h.closes,d1h.volumes);
      const a4h=analyze(d4h.closes,d4h.volumes);
      const a1d=analyze(d1d.closes,d1d.volumes);
      if(!a1h||!a4h||!a1d)continue;

      const buys=[a1h,a4h,a1d].filter(a=>a.signal==='buy').length;
      const sells=[a1h,a4h,a1d].filter(a=>a.signal==='sell').length;
      if(buys!==3&&sells!==3)continue;

      const signal=buys===3?'buy':'sell';
      const price=d1h.closes[d1h.closes.length-1];
      const atr=atrFn(d1d.closes);
      const slMult=signal==='buy'?-1.5:1.5;

      // Use 4H ichimoku for card display
      newSignals.push({
        ...coin,signal,price,
        change:0,ts:Date.now(),
        sl:price+atr*slMult,
        tp1:price-atr*slMult*1.5,
        tp2:price-atr*slMult*3,
        ichi:a4h.ichi,
        analysis1h:a1h,analysis4h:a4h,analysis1d:a1d,
        tf1h:a1h.signal==='buy'?'buy':a1h.signal==='sell'?'sell':'neutral',
        tf4h:a4h.signal==='buy'?'buy':a4h.signal==='sell'?'sell':'neutral',
        tf1d:a1d.signal==='buy'?'buy':a1d.signal==='sell'?'sell':'neutral',
      });
    }catch(e){}
  }

  // Fetch prices
  const priceResults=await Promise.all(newSignals.map(s=>fetchPrice(s.symbol)));
  newSignals.forEach((s,i)=>{if(priceResults[i]){s.price=priceResults[i].price;s.change=priceResults[i].change;}});

  allSignals=newSignals;
  updateSummary();
  renderSignals();
  checkExitSignals(allSignals);

  // Telegram
  if(tgActive&&allSignals.length>0){
    await sendTelegram(`üîç <b>MARKET SCANNER v9 ‚Äì ${new Date().toLocaleString('de-CH')}</b>\nüìä 45 Coins ¬∑ ${allSignals.length} STARK Signal${allSignals.length!==1?'e':''}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
    for(const sig of allSignals){
      const dir=sig.signal==='buy'?'üü¢ KAUFEN':'üî¥ VERKAUFEN';
      await sendTelegram(`${dir} <b>${sig.label}</b> ‚òÖ STARK\n\nüí∞ Preis: <code>${fmtPrice(sig.price)}</code>\nüõë Stop-Loss: <code>${fmtPrice(sig.sl)}</code>\nüéØ TP1: <code>${fmtPrice(sig.tp1)}</code>\nüéØ TP2: <code>${fmtPrice(sig.tp2)}</code>\nüìà RSI: ${(sig.analysis4h?.rsi||0).toFixed(0)}\n‚òÅ Ichimoku: ${sig.ichi.aboveCloud?'√úBER CLOUD':sig.ichi.belowCloud?'UNTER CLOUD':'IN CLOUD'}\n‚è± Alle 3 Timeframes best√§tigt`);
    }
  }

  const now=new Date().toLocaleString('de-CH');
  document.getElementById('lastScan').textContent=`Letzter Scan: ${now} ¬∑ 45 Instrumente ¬∑ ${allSignals.length} Signale`;
  btn.classList.remove('scanning');btn.textContent='‚ü≥ SCAN STARTEN';
  document.getElementById('statusText').textContent='LIVE';

  // Update ages every 30s
  setInterval(()=>{allSignals.forEach(s=>{const el=document.getElementById('age_'+s.symbol);if(el)el.textContent=timeSince(s.ts);});},30000);
}

// ‚îÄ‚îÄ AUTO SCAN ‚îÄ‚îÄ
let scanInterval;
function startAutoScan(){
  runScan();
  scanInterval=setInterval(runScan,30*60*1000);
}

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
function updateClock(){
  document.getElementById('clock').textContent=new Date().toLocaleTimeString('de-CH')+' CET';
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
window.addEventListener('load',()=>{
  updateClock();setInterval(updateClock,1000);
  loadTgSettings();
  renderPositions();
  renderCalendar();
  updateRisk();
  document.getElementById('noSignals').style.display='block';
  setTimeout(startAutoScan,800);
});
</script>
</body>
</html>
